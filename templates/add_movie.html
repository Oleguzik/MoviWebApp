{% extends 'base.html' %}

{% block title %}Add Movie - MoviWebApp{% endblock %}

{% block content %}
<div class="page-container form-container">
	<h2>Add New Movie</h2>
	
	<p class="info-text">
		ðŸ’¡ Tip: Enter just the movie title and we'll fetch director, year, and poster from OMDb!
	</p>
	
	<form method="POST" action="{{ url_for('add_movie', user_id=user_id) }}" class="form-group" id="add-movie-form">
		<div class="form-field">
			<label for="name">Movie Title *</label>
			<div class="input-with-spinner">
				<input 
					type="text" 
					id="name" 
					name="name" 
					class="form-input"
					placeholder="Enter movie title (e.g., The Matrix)"
					required
					maxlength="200"
				>
				<span id="search-spinner" class="spinner hidden"></span>
			</div>
			<small class="omdb-hint">ðŸŽ¬ Just enter the title - we'll fetch director, year & poster from OMDb automatically!</small>
		</div>

		<div class="form-field">
			<label for="director">Director <span class="optional">(auto-filled by OMDb)</span></label>
			<input 
				type="text" 
				id="director" 
				name="director" 
				class="form-input"
				placeholder="Leave empty to auto-fetch from OMDb"
				maxlength="100"
			>
		</div>

		<div class="form-field">
			<label for="year">Year of Release <span class="optional">(auto-filled by OMDb)</span></label>
			<input 
				type="number" 
				id="year" 
				name="year" 
				class="form-input"
				placeholder="Leave empty to auto-fetch from OMDb"
				min="1800"
				max="2099"
			>
		</div>

		<div class="form-field">
			<label for="poster_url">Poster URL</label>
			<input 
				type="url" 
				id="poster_url" 
				name="poster_url" 
				class="form-input"
				placeholder="Enter poster image URL (optional)"
				maxlength="500"
			>
			{% if poster_url %}
				<div class="poster-preview">
					<img src="{{ poster_url }}" alt="Poster preview" class="poster-thumb">
				</div>
			{% endif %}
		</div>

		<div class="form-actions">
			<button type="submit" class="btn btn-success" id="submit-btn">ðŸŽ¬ Add Movie</button>
			<a href="{{ url_for('manage_movies', user_id=user_id) }}" class="btn btn-secondary">Cancel</a>
		</div>
	</form>
</div>

<script>
	// Debounce function to avoid excessive API calls
	function debounce(func, delay) {
		let timeout;
		return function(...args) {
			clearTimeout(timeout);
			timeout = setTimeout(() => func(...args), delay);
		};
	}

	// Get references to form elements
	const nameInput = document.getElementById('name');
	const directorInput = document.getElementById('director');
	const yearInput = document.getElementById('year');
	const posterInput = document.getElementById('poster_url');
	const spinner = document.getElementById('search-spinner');
	const submitBtn = document.getElementById('submit-btn');

	// Function to fetch movie data from server-side API
	const fetchMovieData = debounce(async function() {
		const title = nameInput.value.trim();
		
		// Only fetch if we have a title and director is empty
		if (!title || directorInput.value.trim()) {
			spinner.classList.add('hidden');
			return;
		}

		// Show spinner
		spinner.classList.remove('hidden');
		submitBtn.disabled = true;

		// Note: The actual API call happens on the server side during form submission
		// This is just UI feedback that data will be fetched
		setTimeout(() => {
			spinner.classList.add('hidden');
			submitBtn.disabled = false;
		}, 1000);
	}, 500);

	// Add listener for form submission to show loading state
	document.getElementById('add-movie-form').addEventListener('submit', function(e) {
		// Show loading on submit button
		submitBtn.disabled = true;
		submitBtn.textContent = 'Adding...';
		submitBtn.classList.add('loading');
	});

	// Add event listener to name input
	nameInput.addEventListener('input', fetchMovieData);
</script>

<style>
	.input-with-spinner {
		position: relative;
		display: flex;
		align-items: center;
	}

	.input-with-spinner .form-input {
		flex: 1;
	}

	.spinner {
		width: 20px;
		height: 20px;
		margin-left: -35px;
		margin-right: 10px;
		border: 2px solid #f3f3f3;
		border-top: 2px solid #3498db;
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}

	.spinner.hidden {
		display: none;
	}

	@keyframes spin {
		0% { transform: rotate(0deg); }
		100% { transform: rotate(360deg); }
	}

	.btn.loading {
		opacity: 0.7;
	}

	.info-text {
		background-color: #e3f2fd;
		border-left: 4px solid #3498db;
		padding: 12px;
		margin-bottom: 20px;
		border-radius: 4px;
		color: #1565c0;
	}

	.poster-preview {
		margin-top: 10px;
		padding: 10px;
		background-color: #f5f5f5;
		border-radius: 4px;
		display: inline-block;
	}

	.poster-thumb {
		max-width: 150px;
		max-height: 200px;
		border-radius: 4px;
		box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
	}

	.optional {
		font-size: 0.8em;
		color: #7f8c8d;
		font-weight: normal;
	}

	.omdb-hint {
		color: #27ae60;
		font-weight: 500;
		display: block;
		margin-top: 6px;
	}

	.form-field small {
		display: block;
		margin-top: 4px;
		color: #7f8c8d;
	}
</style>
{% endblock %}